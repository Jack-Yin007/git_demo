//////////////////////////////////////////////////////////////////////////
//
// Convert thermistor resistance (ohm) to temperature (degrees Celsius)
//
//////////////////////////////////////////////////////////////////////////
#include "ntc_tmp_conv.h"

typedef struct
{
	int16_t Temp;	// Temperature. Unit in degrees Celsius
	double Res;		// Resistance. Unit in Ohm
} TempRis_t;		// Temperature-Resistance point

// Temperature-Resistance curve of thermistor
static TempRis_t TRCurve[] = 
{
	{-40, 228237.6},
	{-39, 214869.6},
	{-38, 202382.6},
	{-37, 190712.6},
	{-36, 179800.5},
	{-35, 169591.9},
	{-34, 160036.6},
	{-33, 151088.4},
	{-32, 142704.6},
	{-31, 134845.9},
	{-30, 127475.9},
	{-29, 120560.8},
	{-28, 114069.6},
	{-27, 107973.5},
	{-26, 102245.9},
	{-25, 96862},
	{-24, 91799},
	{-23, 87035.7},
	{-22, 82552.3},
	{-21, 78330.6},
	{-20, 74353.8},
	{-19, 70605.8},
	{-18, 67072.3},
	{-17, 63739.4},
	{-16, 60594.6},
	{-15, 57626.1},
	{-14, 54822.8},
	{-13, 52174.5},
	{-12, 49671.7},
	{-11, 47305.6},
	{-10, 45067.6},
	{-9, 42950.3},
	{-8, 40946.2},
	{-7, 39048.7},
	{-6, 37251.4},
	{-5, 35548.4},
	{-4, 33934.2},
	{-3, 32403.7},
	{-2, 30952},
	{-1, 29574.5},
	{0, 28267.1},
	{1, 27025.7},
	{2, 25846.6},
	{3, 24726.4},
	{4, 23661.7},
	{5, 22649.5},
	{6, 21686.9},
	{7, 20771.1},
	{8, 19899.6},
	{9, 19070},
	{10, 18280.1},
	{11, 17527.6},
	{12, 16810.8},
	{13, 16127.5},
	{14, 15476.2},
	{15, 14855},
	{16, 14262.5},
	{17, 13697.2},
	{18, 13157.6},
	{19, 12642.5},
	{20, 12150.5},
	{21, 11680.6},
	{22, 11231.6},
	{23, 10802.5},
	{24, 10392.3},
	{25, 10000},
	{26, 9624.8},
	{27, 9265.8},
	{28, 8922.3},
	{29, 8593.4},
	{30, 8278.6},
	{31, 7977},
	{32, 7688.2},
	{33, 7411.4},
	{34, 7146.1},
	{35, 6891.9},
	{36, 6648},
	{37, 6414.2},
	{38, 6189.9},
	{39, 5974.6},
	{40, 5768},
	{41, 5569.7},
	{42, 5379.3},
	{43, 5196.4},
	{44, 5020.8},
	{45, 4852},
	{46, 4689.8},
	{47, 4533.9},
	{48, 4384},
	{49, 4239.8},
	{50, 4101.2},
	{51, 3967.8},
	{52, 3839.5},
	{53, 3716},
	{54, 3597.1},
	{55, 3482.6},
	{56, 3372.4},
	{57, 3266.2},
	{58, 3163.9},
	{59, 3065.4},
	{60, 2970.4},
	{61, 2878.8},
	{62, 2790.5},
	{63, 2705.4},
	{64, 2623.3},
	{65, 2544.2},
	{66, 2467.8},
	{67, 2394},
	{68, 2322.9},
	{69, 2254.2},
	{70, 2187.9},
	{71, 2123.9},
	{72, 2062},
	{73, 2002.3},
	{74, 1944.6},
	{75, 1888.8},
	{76, 1834.9},
	{77, 1782.8},
	{78, 1732.4},
	{79, 1683.7},
	{80, 1636.6},
	{81, 1591},
	{82, 1546.9},
	{83, 1504.3},
	{84, 1463},
	{85, 1423.1},
	{86, 1384.4},
	{87, 1347},
	{88, 1310.7},
	{89, 1275.6},
	{90, 1241.6},
	{91, 1208.7},
	{92, 1176.8},
	{93, 1145.9},
	{94, 1115.9},
	{95, 1086.8},
	{96, 1058.7},
	{97, 1031.4},
	{98, 1004.9},
	{99, 979.2},
	{100, 954.3},
	{101, 930.2},
	{102, 906.7},
	{103, 884},
	{104, 861.9},
	{105, 840.5},
	{106, 819.7},
	{107, 799.5},
	{108, 779.9},
	{109, 760.8},
	{110, 742.3},
	{111, 724.4},
	{112, 706.9},
	{113, 690},
	{114, 673.5},
	{115, 657.5},
	{116, 641.9},
	{117, 626.8},
	{118, 612.1},
	{119, 597.8},
	{120, 583.9},
	{121, 570.3},
	{122, 557.2},
	{123, 544.4},
	{124, 531.9},
	{125, 519.8},
};

// Find the position i, that (TRCurve[i] < Res) in T-R curve table
// Parameter: Res, Unit in Ohm
// Return value: 
//     0, not found, Res is larger than any value in TRCurve[]
//     1 ~ (TR_table_len-1), found
//     (TR_table_len), not found, Res is smaller than any value in TRCurve[]
static int16_t FindPosRes(double Res)
{
	int16_t i = 0;
	uint8_t Len = sizeof(TRCurve)/sizeof(TRCurve[0]);
	
	for(i = 0; i < Len; i++)
	{
		if(TRCurve[i].Res < Res)
			break;
	}
	return i;
}

// Calculate temperature acooding to resistance value
// Parameter: Res: given resistance value. Unit in Ohm
// Parameter: pTemp, calculated temperature. Unit in degrees Celsius.
// Return value: true, OK; false, error
void CalTemp(double Res, int16_t *pTemp)
{
	int16_t Pos = FindPosRes(Res);
	uint8_t Len = sizeof(TRCurve)/sizeof(TRCurve[0]);	
	if(!Pos)				// Pos == 0
		*pTemp = TRCurve[0].Temp;
	else if(Pos >= Len)		// Pos >= Len
		*pTemp = TRCurve[Len-1].Temp;
	else					// Pos ranges 1~(Len-1)
	{
//		if(!(TRCurve[Pos-1].Res - TRCurve[Pos].Res))	// Avoid divider that's equal to 0
//			return false;
//		*pTemp = (TRCurve[Pos-1].Temp + 1.0*(TRCurve[Pos].Temp - TRCurve[Pos-1].Temp)*(TRCurve[Pos-1].Res - Res)/(TRCurve[Pos-1].Res - TRCurve[Pos].Res));
		*pTemp = TRCurve[Pos].Temp;
	}
//	return true;
}
